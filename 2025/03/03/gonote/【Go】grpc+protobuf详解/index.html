<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>【Go】grpc+protobuf详解 - shn&#039;s blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="shn&#039;s blog"><meta name="msapplication-TileImage" content="/images/icon_blog.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="shn&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="点击阅读更多查看文章内容"><meta property="og:type" content="blog"><meta property="og:title" content="【Go】grpc+protobuf详解"><meta property="og:url" content="https://shnpd.github.io/2025/03/03/gonote/%E3%80%90Go%E3%80%91grpc+protobuf%E8%AF%A6%E8%A7%A3/"><meta property="og:site_name" content="shn&#039;s blog"><meta property="og:description" content="点击阅读更多查看文章内容"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024222.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024223.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024224.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024225.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024226.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024227.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024228.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024229.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024230.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810860.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810861.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810863.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810864.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810865.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810866.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024231.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024232.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024233.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024234.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024235.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024236.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024237.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024238.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024239.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024241.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024242.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024243.png"><meta property="article:published_time" content="2025-03-02T16:00:00.000Z"><meta property="article:modified_time" content="2025-03-19T15:04:18.101Z"><meta property="article:author" content="ShiHaonan"><meta property="article:tag" content="go"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024222.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://shnpd.github.io/2025/03/03/gonote/%E3%80%90Go%E3%80%91grpc+protobuf%E8%AF%A6%E8%A7%A3/"},"headline":"【Go】grpc+protobuf详解","image":["https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024222.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024223.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024224.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024225.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024226.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024227.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024228.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024229.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024230.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810860.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810861.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810863.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810864.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810865.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810866.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024231.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024232.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024233.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024234.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024235.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024236.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024237.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024238.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024239.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024241.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024242.png","https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024243.png"],"datePublished":"2025-03-02T16:00:00.000Z","dateModified":"2025-03-19T15:04:18.101Z","author":{"@type":"Person","name":"ShiHaonan"},"publisher":{"@type":"Organization","name":"shn's blog","logo":{"@type":"ImageObject","url":{"text":"shn's blog"}}},"description":"点击阅读更多查看文章内容"}</script><link rel="canonical" href="https://shnpd.github.io/2025/03/03/gonote/%E3%80%90Go%E3%80%91grpc+protobuf%E8%AF%A6%E8%A7%A3/"><link rel="icon" href="/images/icon_blog.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><meta name="msvalidate.01" content="E38AFEA650A8300110261393E7FD0A39"><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">shn&#039;s blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2025-03-02T16:00:00.000Z" title="3/3/2025, 12:00:00 AM">2025-03-03</time>发表</span><span class="level-item"><time dateTime="2025-03-19T15:04:18.101Z" title="3/19/2025, 11:04:18 PM">2025-03-19</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Golang/">Golang</a></span><span class="level-item">33 分钟读完 (大约4949个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">【Go】grpc+protobuf详解</h1><div class="content"><p>点击阅读更多查看文章内容<span id="more"></span></p>
<h2 id="Protobuf详解"><a href="#Protobuf详解" class="headerlink" title="Protobuf详解"></a>Protobuf详解</h2><p>官方地址： <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">https://developers.google.com/protocol-buffers/docs/proto3</a></p>
<p>数据类型</p>
<table>
<thead>
<tr>
<th align="left">.proto Type</th>
<th align="left">Notes</th>
<th align="left">Go Type</th>
</tr>
</thead>
<tbody><tr>
<td align="left">double</td>
<td align="left"></td>
<td align="left">float64</td>
</tr>
<tr>
<td align="left">float</td>
<td align="left"></td>
<td align="left">float32</td>
</tr>
<tr>
<td align="left">int32</td>
<td align="left">使用变长编码，对于负值的效率很低，如果你的域有可能有负值，请使用sint64替代</td>
<td align="left">int32</td>
</tr>
<tr>
<td align="left">uint32</td>
<td align="left">使用变长编码</td>
<td align="left">uint32</td>
</tr>
<tr>
<td align="left">uint64</td>
<td align="left">使用变长编码</td>
<td align="left">uint64</td>
</tr>
<tr>
<td align="left">sint32</td>
<td align="left">使用变长编码，这些编码在负值时比int32高效的多</td>
<td align="left">int32</td>
</tr>
<tr>
<td align="left">sint64</td>
<td align="left">使用变长编码，有符号的整型值。编码时比通常的int64高效。</td>
<td align="left">int64</td>
</tr>
<tr>
<td align="left">fixed32</td>
<td align="left">总是4个字节，如果数值总是比总是比228大的话，这个类型会比uint32高效。</td>
<td align="left">uint32</td>
</tr>
<tr>
<td align="left">fixed64</td>
<td align="left">总是8个字节，如果数值总是比总是比256大的话，这个类型会比uint64高效。</td>
<td align="left">uint64</td>
</tr>
<tr>
<td align="left">sfixed32</td>
<td align="left">总是4个字节</td>
<td align="left">int32</td>
</tr>
<tr>
<td align="left">sfixed64</td>
<td align="left">总是8个字节</td>
<td align="left">int64</td>
</tr>
<tr>
<td align="left">bool</td>
<td align="left"></td>
<td align="left">bool</td>
</tr>
<tr>
<td align="left">string</td>
<td align="left">一个字符串必须是UTF-8编码或者7-bit ASCII编码的文本。</td>
<td align="left">string</td>
</tr>
<tr>
<td align="left">bytes</td>
<td align="left">可能包含任意顺序的字节数据。</td>
<td align="left"></td>
</tr>
</tbody></table>
<hr>
<h3 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a><strong>默认值</strong></h3><p>当一个消息被解析的时候，如果被编码的信息不包含一个特定的singular元素，被解析的对象所对应的域被设置位一个默认值，对于不同类型指定如下：</p>
<ul>
<li>对于strings，默认是一个空string</li>
<li>对于bytes，默认是一个空的bytes</li>
<li>对于bools，默认是false</li>
<li>对于数值类型，默认是0</li>
<li>对于枚举，默认是第一个定义的枚举值，必须为0;</li>
</ul>
<hr>
<h3 id="option-go-package"><a href="#option-go-package" class="headerlink" title="option go_package"></a><strong>option go_package</strong></h3><p>指明生成文件的目录以及包名，option go_package&#x3D;“.;proto”，在当前目录下生成文件，文件package为proto，使用go_package后无需为proto文件再单独定义package</p>
<hr>
<h3 id="编号问题"><a href="#编号问题" class="headerlink" title="编号问题"></a><strong>编号问题</strong></h3><p>客户端定义</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Data</span>&#123;</span><br><span class="line">	<span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">	<span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端定义</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">Data</span>&#123;</span><br><span class="line">	<span class="type">string</span> name = <span class="number">2</span>;</span><br><span class="line">	<span class="type">string</span> url = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果两个文件的序号不对应那么最终的结果是，客户端发送的name在服务端被解析为url，客户端发送的url在服务端被解析为name</p>
<blockquote>
<p> 假设name为tom，url为tom.com，那么实际传输的数据类似1(序号)3(长度)tom27tom.com</p>
</blockquote>
<hr>
<h3 id="import其它的proto文件"><a href="#import其它的proto文件" class="headerlink" title="import其它的proto文件"></a><strong>import其它的proto文件</strong></h3><img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024222.png" alt="image-20250204230746070" style="zoom: 80%;" />

<p><img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024223.png" alt="image-20250204230825975"></p>
<p>自定义文件在代码中使用时需要生成import的proto的代码（两个proto文件都在同一目录下直接import一个package即可）</p>
<p>内置文件需要import文件中的go_package</p>
<p>empty.proto</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024224.png" alt="image-20250204234153497" style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024225.png" alt="image-20250204234215359" style="zoom:67%;" />

<hr>
<h3 id="嵌套的message对象"><a href="#嵌套的message对象" class="headerlink" title="嵌套的message对象"></a><strong>嵌套的message对象</strong></h3><p>message只放在需要它的message里面，避免公共message的爆炸式增长</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">message </span><span class="title class_">Result</span> &#123;</span><br><span class="line">        <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">        <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">repeated</span> Result data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成代码调用时可以通过 <code>proto.HelloReply_Result</code> 对其进行实例化</p>
<hr>
<h3 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a><strong>枚举类型</strong></h3><p>proto文件定义</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum </span><span class="title class_">Gender</span>&#123;</span><br><span class="line">    MALE = <span class="number">0</span>;</span><br><span class="line">    FEMALE = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成代码使用：<code>proto_bak.Gender_MALE</code></p>
<p>生成的Gender是int32类型，对每个值都会生成对应的常量</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024226.png" alt="image-20250204232609929" style="zoom:67%;" />

<hr>
<h3 id="map类型"><a href="#map类型" class="headerlink" title="map类型"></a><strong>map类型</strong></h3><p>proto文件定义：</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024227.png" alt="image-20250204232920851" style="zoom:67%;" />

<p>生成代码：</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024228.png" alt="image-20250204232947785" style="zoom:67%;" />

<p>使用：</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024229.png" alt="image-20250204233003733" style="zoom:67%;" />



<hr>
<h3 id="内置timestamp类型"><a href="#内置timestamp类型" class="headerlink" title="内置timestamp类型"></a><strong>内置timestamp类型</strong></h3><p>proto文件定义：</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024230.png" alt="image-20250204233944576" style="zoom:67%;" />

<hr>
<h2 id="grpc详解"><a href="#grpc详解" class="headerlink" title="grpc详解"></a>grpc详解</h2><h3 id="什么是rpc"><a href="#什么是rpc" class="headerlink" title="什么是rpc"></a>什么是rpc</h3><p>实现rpc调用主要解决三个问题：</p>
<ol>
<li><strong>Call ID映射</strong>。我们怎么告诉远程机器我们要调用add，而不是sub或者Foo呢？在本地调用中，函数体是直接通过函数指针来指定的，我们调用add，编译器就自动帮我们调用它相应的函数指针。但是在远程调用中，函数指针是不行的，因为两个进程的地址空间是完全不一样的。所以，在RPC中，所有的函数都必须有自己的一个ID。这个ID在所有进程中都是唯一确定的。客户端在做远程过程调用时，必须附上这个ID。然后我们还需要在客户端和服务端分别维护一个 {函数 &lt;–&gt; Call ID} 的对应表。两者的表不一定需要完全相同，但相同的函数对应的Call ID必须相同。当客户端需要进行远程调用时，它就查一下这个表，找出相应的Call ID，然后把它传给服务端，服务端也通过查表，来确定客户端需要调用的函数，然后执行相应函数的代码。</li>
<li><strong>序列化和反序列化</strong>。客户端怎么把参数值传给远程的函数呢？在本地调用中，我们只需要把参数压到栈里，然后让函数自己去栈里读就行。但是在远程过程调用时，客户端跟服务端是不同的进程，不能通过内存来传递参数。甚至有时候客户端和服务端使用的都不是同一种语言（比如服务端用C++，客户端用Java或者Python）。这时候就需要客户端把参数先转成一个字节流，传给服务端后，再把字节流转成自己能读取的格式。这个过程叫序列化和反序列化。同理，从服务端返回的值也需要序列化反序列化的过程。</li>
<li><strong>网络传输</strong>。远程调用往往用在网络上，客户端和服务端是通过网络连接的。所有的数据都需要通过网络传输，因此就需要有一个网络传输层。网络传输层需要把Call ID和序列化后的参数字节流传给服务端，然后再把序列化后的调用结果传回客户端。只要能完成这两者的，都可以作为传输层使用。因此，它所使用的协议其实是不限的，能完成传输就行。尽管大部分RPC框架都使用TCP协议，但其实UDP也可以，而gRPC干脆就用了HTTP2。Java的Netty也属于这层的东西。</li>
</ol>
<h4 id="rpc开发的四大要素"><a href="#rpc开发的四大要素" class="headerlink" title="rpc开发的四大要素"></a>rpc开发的四大要素</h4><p>RPC技术在架构设计上有四部分组成，分别是：<strong>客户端、客户端存根、服务端、服务端存根。</strong></p>
<blockquote>
<p><strong>通过stub屏蔽掉网络通信的内容，使得在客户端调用远程的函数就跟调用本地函数一样</strong></p>
</blockquote>
<ul>
<li><strong>客户端(Client)：</strong>服务调用发起方，也称为服务消费者。</li>
<li><strong>客户端存根(Client Stub)：</strong>该程序运行在客户端所在的计算机机器上，主要用来存储要调用的服务器的地址，另外，该程序还负责将客户端请求远端服务器程序的数据信息打包成数据包，通过网络发送给服务端Stub程序；其次，还要接收服务端Stub程序发送的调用结果数据包，并解析返回给客户端。</li>
<li><strong>服务端(Server)：</strong>远端的计算机机器上运行的程序，其中有客户端要调用的方法。</li>
<li><strong>服务端存根(Server Stub)：</strong>接收客户Stub程序通过网络发送的请求消息数据包，并调用服务端中真正的程序功能方法，完成功能调用；其次，将服务端执行调用的结果进行数据处理打包发送给客户端Stub程序。</li>
</ul>
<p>了解完了RPC技术的组成结构我们来看一下具体是如何实现客户端到服务端的调用的。实际上，如果我们想要在网络中的任意两台计算机上实现远程调用过程，要解决很多问题，比如：</p>
<ul>
<li>两台物理机器在网络中要建立稳定可靠的通信连接。</li>
<li>两台服务器的通信协议的定义问题，即两台服务器上的程序如何识别对方的请求和返回结果。也就是说两台计算机必须都能够识别对方发来的信息，并且能够识别出其中的请求含义和返回含义，然后才能进行处理。这其实就是通信协议所要完成的工作。</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810860.png" alt="image-20250130232829575" style="zoom:67%;" />

<p>在上述图中，通过1-10的步骤图解的形式，说明了RPC每一步的调用过程。具体描述为：</p>
<ul>
<li>1、客户端想要发起一个远程过程调用，首先通过调用本地客户端Stub程序的方式调用想要使用的功能方法名；</li>
<li>2、客户端Stub程序接收到了客户端的功能调用请求，<strong>将客户端请求调用的方法名，携带的参数等信息做序列化操作，并打包成数据包。</strong></li>
<li>3、客户端Stub查找到远程服务器程序的IP地址，调用Socket通信协议，通过网络发送给服务端。</li>
<li>4、服务端Stub程序接收到客户端发送的数据包信息，并<strong>通过约定好的协议将数据进行反序列化，得到请求的方法名和请求参数等信息。</strong></li>
<li>5、服务端Stub程序准备相关数据，<strong>调用本地Server对应的功能方法进行，并传入相应的参数，进行业务处理。</strong></li>
<li>6、服务端程序根据已有业务逻辑执行调用过程，待业务执行结束，将执行结果返回给服务端Stub程序。</li>
<li>7、服务端Stub程序<strong>将程序调用结果按照约定的协议进行序列化，</strong>并通过网络发送回客户端Stub程序。</li>
<li>8、客户端Stub程序接收到服务端Stub发送的返回数据，<strong>对数据进行反序列化操作，</strong>并将调用返回的数据传递给客户端请求发起者。</li>
<li>9、客户端请求发起者得到调用结果，整个RPC调用过程结束。</li>
</ul>
<h2 id="grpc"><a href="#grpc" class="headerlink" title="grpc"></a>grpc</h2><p>gRPC 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP&#x2F;2 设计。目前提供 C、Java 和 Go 语言版本，分别是：<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc">grpc</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-java">grpc-java</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-go">grpc-go</a>. 其中 C 版本支持 <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc">C</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/cpp">C++</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/node">Node.js</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/python">Python</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/ruby">Ruby</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/objective-c">Objective-C</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/php">PHP</a> 和 <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/csharp">C#</a> 支持.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/grpc/grpc">grpc项目地址</a></p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810861.png" alt="image-20250201183151401" style="zoom:67%;" />

<h3 id="grpc的四种数据流"><a href="#grpc的四种数据流" class="headerlink" title="grpc的四种数据流"></a>grpc的四种数据流</h3><img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810863.png" alt="image-20250201234141191" style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810864.png" alt="image-20250201234152361" style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810865.png" alt="image-20250201234207109" style="zoom:67%;" />

<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303125810866.png" alt="image-20250201234221126" style="zoom:67%;" />

<h3 id="proto"><a href="#proto" class="headerlink" title="proto"></a>proto</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;<span class="comment">//声明proto的版本 只能 是3，才支持 grpc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明 包名</span></span><br><span class="line"><span class="keyword">option</span> go_package=<span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明grpc服务</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    以下 分别是 服务端 推送流， 客户端 推送流 ，双向流。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> GetStream (StreamReqData) <span class="keyword">returns</span> (stream StreamResData)</span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> PutStream (stream StreamReqData) <span class="keyword">returns</span> (StreamResData)</span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> AllStream (stream StreamReqData) <span class="keyword">returns</span> (stream StreamResData)</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//stream请求结构</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">StreamReqData</span> &#123;</span><br><span class="line">    <span class="type">string</span> data = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//stream返回结构</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">StreamResData</span> &#123;</span><br><span class="line">    <span class="type">string</span> data = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;start/new_stream/proto&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT  = <span class="string">&quot;:50052&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端 单向流</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span>GetStream(req *proto.StreamReqData, res proto.Greeter_GetStreamServer) <span class="type">error</span>&#123;</span><br><span class="line">	i:= <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span>&#123;</span><br><span class="line">		i++</span><br><span class="line">		res.Send(&amp;proto.StreamResData&#123;Data:fmt.Sprintf(<span class="string">&quot;%v&quot;</span>,time.Now().Unix())&#125;)</span><br><span class="line">		time.Sleep(<span class="number">1</span>*time.Second)</span><br><span class="line">		<span class="keyword">if</span> i &gt;<span class="number">10</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端 单向流</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> PutStream(cliStr proto.Greeter_PutStreamServer) <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> tem, err := cliStr.Recv(); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(tem)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;break, err :&quot;</span>, err)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//客户端服务端 双向流</span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(s *server)</span></span> AllStream(allStr proto.Greeter_AllStreamServer) <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">	wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			data, _ := allStr.Recv()</span><br><span class="line">			log.Println(data)</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			allStr.Send(&amp;proto.StreamResData&#123;Data:<span class="string">&quot;ssss&quot;</span>&#125;)</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">		&#125;</span><br><span class="line">		wg.Done()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//监听端口</span></span><br><span class="line">	lis,err := net.Listen(<span class="string">&quot;tcp&quot;</span>,PORT)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建一个grpc 服务器</span></span><br><span class="line">	s := grpc.NewServer()</span><br><span class="line">	<span class="comment">//注册事件</span></span><br><span class="line">	proto.RegisterGreeterServer(s,&amp;server&#123;&#125;)</span><br><span class="line">	<span class="comment">//处理链接</span></span><br><span class="line">	err = s.Serve(lis)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	_ <span class="string">&quot;google.golang.org/grpc/balancer/grpclb&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;start/new_stream/proto&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	ADDRESS = <span class="string">&quot;localhost:50052&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//通过grpc 库 建立一个连接</span></span><br><span class="line">	conn ,err := grpc.Dial(ADDRESS,grpc.WithInsecure())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line">	<span class="comment">//通过刚刚的连接 生成一个client对象。</span></span><br><span class="line">	c := proto.NewGreeterClient(conn)</span><br><span class="line">	<span class="comment">//调用服务端推送流</span></span><br><span class="line">	reqstreamData := &amp;proto.StreamReqData&#123;Data:<span class="string">&quot;aaa&quot;</span>&#125;</span><br><span class="line">	res,_ := c.GetStream(context.Background(),reqstreamData)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		aa,err := res.Recv()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Println(aa)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//客户端 推送 流</span></span><br><span class="line">	putRes, _ := c.PutStream(context.Background())</span><br><span class="line">	i := <span class="number">1</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		i++</span><br><span class="line">		putRes.Send(&amp;proto.StreamReqData&#123;Data:<span class="string">&quot;ss&quot;</span>&#125;)</span><br><span class="line">		time.Sleep(time.Second)</span><br><span class="line">		<span class="keyword">if</span> i &gt; <span class="number">10</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//服务端 客户端 双向流</span></span><br><span class="line">	allStr,_ := c.AllStream(context.Background())</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			data,_ := allStr.Recv()</span><br><span class="line">			log.Println(data)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			allStr.Send(&amp;proto.StreamReqData&#123;Data:<span class="string">&quot;ssss&quot;</span>&#125;)</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">select</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="grpc的metadata机制"><a href="#grpc的metadata机制" class="headerlink" title="grpc的metadata机制"></a><strong>grpc的metadata机制</strong></h3><p><strong>grpc中的metadata类似于http中的header，可以用来存放一些元信息（如token）</strong></p>
<p>gRPC让我们可以像本地调用一样实现远程调用，对于每一次的RPC调用中，都可能会有一些有用的数据，而这些数据就可以通过metadata来传递。metadata是以key-value的形式存储数据的，其中key是<code>string</code>类型，而value是<code>[]string</code>，即一个字符串数组类型。metadata使得client和server能够为对方提供关于本次调用的一些信息，metadata的生命周期就是一次RPC调用。</p>
<p><strong>新建metadata</strong></p>
<p>MD 类型实际上是map，key是string，value是string类型的slice。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MD <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span></span><br></pre></td></tr></table></figure>

<p>创建的时候可以像创建普通的map类型一样使用new关键字进行创建：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种方式</span></span><br><span class="line">md := metadata.New(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;key1&quot;</span>: <span class="string">&quot;val1&quot;</span>, <span class="string">&quot;key2&quot;</span>: <span class="string">&quot;val2&quot;</span>&#125;)</span><br><span class="line"><span class="comment">//第二种方式 key不区分大小写，会被统一转成小写。</span></span><br><span class="line">md := metadata.Pairs(</span><br><span class="line">    <span class="string">&quot;key1&quot;</span>, <span class="string">&quot;val1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;key1&quot;</span>, <span class="string">&quot;val1-2&quot;</span>, <span class="comment">// &quot;key1&quot; will have map value []string&#123;&quot;val1&quot;, &quot;val1-2&quot;&#125;</span></span><br><span class="line">    <span class="string">&quot;key2&quot;</span>, <span class="string">&quot;val2&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p> <strong>发送metadata</strong>：将metadata添加到context中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">md := metadata.Pairs(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;val&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新建一个有 metadata 的 context</span></span><br><span class="line">ctx := metadata.NewOutgoingContext(context.Background(), md)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单向 RPC</span></span><br><span class="line">response, err := client.SomeRPC(ctx, someRequest)</span><br></pre></td></tr></table></figure>

<p><strong>接收metadata</strong>：从context中取出metadata</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> SomeRPC(ctx context.Context, in *pb.SomeRequest) (*pb.SomeResponse, err) &#123;</span><br><span class="line">    md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">    <span class="comment">// do something with metadata</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="grpc拦截器"><a href="#grpc拦截器" class="headerlink" title="grpc拦截器"></a><strong>grpc拦截器</strong></h3><p>gRPC 拦截器主要分为两种：客户端拦截器（ClientInterceptor），服务端拦截器（ServerInterceptor），顾名思义，分别于请求的两端执行相应的前拦截处理。</p>
<ul>
<li>客户端拦截器</li>
</ul>
<p>1、作用时机？</p>
<p>请求被分发出去之前。</p>
<p>2、可以做什么？</p>
<p>a)、请求日志记录及监控</p>
<p>b)、添加请求头数据、以便代理转发使用</p>
<p>c)、请求或者结果重写</p>
<p>3、实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;start/grpc_interceptor/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">interceptor</span><span class="params">(ctx context.Context, method <span class="type">string</span>, req, reply <span class="keyword">interface</span>&#123;&#125;, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	start := time.Now()</span><br><span class="line">	err := invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;method=%s req=%v rep=%v duration=%s error=%v\n&quot;</span>, method, req, reply, time.Since(start), err)</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">//stream</span></span><br><span class="line">	<span class="keyword">var</span> opts []grpc.DialOption</span><br><span class="line"></span><br><span class="line">	opts = <span class="built_in">append</span>(opts, grpc.WithInsecure())</span><br><span class="line">	<span class="comment">// 指定客户端interceptor</span></span><br><span class="line">	opts = <span class="built_in">append</span>(opts, grpc.WithUnaryInterceptor(interceptor))</span><br><span class="line"></span><br><span class="line">	conn, err := grpc.Dial(<span class="string">&quot;localhost:50051&quot;</span>, opts...)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	c := proto.NewGreeterClient(conn)</span><br><span class="line">	r, err := c.SayHello(context.Background(), &amp;proto.HelloRequest&#123;Name:<span class="string">&quot;bobby&quot;</span>&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(r.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>服务端拦截器</li>
</ul>
<p>1、作用时机？</p>
<p>请求被具体的Handler相应前。</p>
<p>2、可以做什么？</p>
<p>a）访问认证</p>
<p>b）请求日志记录及监控</p>
<p>c）代理转发</p>
<p>3、实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span></span> SayHello(ctx context.Context, request *proto.HelloRequest) (*proto.HelloReply,</span><br><span class="line">	<span class="type">error</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;proto.HelloReply&#123;</span><br><span class="line">		Message: <span class="string">&quot;hello &quot;</span>+request.Name,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> interceptor grpc.UnaryServerInterceptor</span><br><span class="line">	interceptor = <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="comment">// 继续处理请求</span></span><br><span class="line">		fmt.Println(<span class="string">&quot;接收到新请求&quot;</span>)</span><br><span class="line">		res, err := handler(ctx, req)</span><br><span class="line">		fmt.Println(<span class="string">&quot;请求处理完成&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> res, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> opts []grpc.ServerOption</span><br><span class="line">	opts = <span class="built_in">append</span>(opts, grpc.UnaryInterceptor(interceptor))</span><br><span class="line"></span><br><span class="line">	g := grpc.NewServer(opts...)</span><br><span class="line">	proto.RegisterGreeterServer(g, &amp;Server&#123;&#125;)</span><br><span class="line">	lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:50051&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;failed to listen:&quot;</span>+err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	err = g.Serve(lis)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc:&quot;</span>+err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 拦截器的应用场景：<a target="_blank" rel="noopener" href="https://github.com/grpc-ecosystem/go-grpc-middleware">go-grpc-middleware</a></p>
<hr>
<h3 id="通过拦截器和metadata实现grpc的auth认证"><a href="#通过拦截器和metadata实现grpc的auth认证" class="headerlink" title="通过拦截器和metadata实现grpc的auth认证"></a><strong>通过拦截器和metadata实现grpc的auth认证</strong></h3><p>客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interceptor := <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, method <span class="type">string</span>, req, reply <span class="keyword">interface</span>&#123;&#125;, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	start := time.Now()</span><br><span class="line">	md := metadata.New(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">		<span class="string">&quot;appid&quot;</span>:<span class="string">&quot;10101&quot;</span>,</span><br><span class="line">		<span class="string">&quot;appkey&quot;</span>:<span class="string">&quot;i am key&quot;</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	ctx = metadata.NewOutgoingContext(context.Background(), md)</span><br><span class="line">	err := invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;耗时：%s\n&quot;</span>, time.Since(start))</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">interceptor = <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">	md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> resp, status.Errorf(codes.Unauthenticated, <span class="string">&quot;无Token认证信息&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		appid  <span class="type">string</span></span><br><span class="line">		appkey <span class="type">string</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> val, ok := md[<span class="string">&quot;appid&quot;</span>]; ok &#123;</span><br><span class="line">		appid = val[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> val, ok := md[<span class="string">&quot;appkey&quot;</span>]; ok &#123;</span><br><span class="line">		appkey = val[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> appid != <span class="string">&quot;imooc&quot;</span> || appkey != <span class="string">&quot;bobby&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> resp, status.Errorf(codes.Unauthenticated, <span class="string">&quot;Token认证信息无效: appid=%s, appkey=%s&quot;</span>, appid, appkey)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 继续处理请求</span></span><br><span class="line">	<span class="keyword">return</span> handler(ctx, req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="grpc的验证器"><a href="#grpc的验证器" class="headerlink" title="grpc的验证器"></a><strong>grpc的验证器</strong></h3><p><a target="_blank" rel="noopener" href="https://github.com/envoyproxy/protoc-gen-validate">protoc-gen_validate</a>，验证proto中定义的message是否符合某个规则</p>
<p>生成源码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I .  --go_out=plugins=grpc:. --validate_out=&quot;lang=go:.&quot; helloworld.proto</span><br></pre></td></tr></table></figure>

<ol>
<li>新建validate.proto文件内容从 <a target="_blank" rel="noopener" href="https://github.com/envoyproxy/protoc-gen-validate/blob/master/validate/validate.proto">https://github.com/envoyproxy/protoc-gen-validate/blob/master/validate/validate.proto</a> 拷贝</li>
<li>新建helloworl.proto文件</li>
</ol>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;validate.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package=<span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (Person) <span class="keyword">returns</span> (Person)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="type">uint64</span> id    = <span class="number">1</span> [(validate.rules).<span class="type">uint64</span>.gt    = <span class="number">999</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">string</span> email = <span class="number">2</span> [(validate.rules).<span class="type">string</span>.email = <span class="literal">true</span>];</span><br><span class="line">    <span class="type">string</span> name  = <span class="number">3</span> [(validate.rules).<span class="type">string</span> = &#123;</span><br><span class="line">                      pattern:   <span class="string">&quot;^[^[0-9]A-Za-z]+( [^[0-9]A-Za-z]+)*$&quot;</span>,max_bytes: <span class="number">256</span>,&#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span>  main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">	<span class="string">&quot;start/pgv_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> customCredential <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> opts []grpc.DialOption</span><br><span class="line"></span><br><span class="line">	<span class="comment">//opts = append(opts, grpc.WithUnaryInterceptor(interceptor))</span></span><br><span class="line">	opts = <span class="built_in">append</span>(opts, grpc.WithInsecure())</span><br><span class="line"></span><br><span class="line">	conn, err := grpc.Dial(<span class="string">&quot;localhost:50051&quot;</span>, opts...)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">	c := proto.NewGreeterClient(conn)</span><br><span class="line">	<span class="comment">//rsp, _ := c.Search(context.Background(), &amp;empty.Empty&#123;&#125;)</span></span><br><span class="line">	rsp, err := c.SayHello(context.Background(), &amp;proto.Person&#123;</span><br><span class="line">		Email: <span class="string">&quot;bobby&quot;</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(rsp.Id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端：通过validate方法就可以验证规则，不符合则返回error，直接定义一个包含validate方法的接口，validate方法实现在生成的validate文件中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc/codes&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc/status&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;start/pgv_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span></span> SayHello(ctx context.Context, request *proto.Person) (*proto.Person,</span><br><span class="line">	<span class="type">error</span>)&#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;proto.Person&#123;</span><br><span class="line">		Id: <span class="number">32</span>,</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Validator <span class="keyword">interface</span> &#123;</span><br><span class="line">	Validate() <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> interceptor grpc.UnaryServerInterceptor</span><br><span class="line">	interceptor = <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="comment">// 继续处理请求</span></span><br><span class="line">		<span class="keyword">if</span> r, ok := req.(Validator); ok &#123;</span><br><span class="line">			<span class="keyword">if</span> err := r.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, status.Error(codes.InvalidArgument, err.Error())</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> handler(ctx, req)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> opts []grpc.ServerOption</span><br><span class="line">	opts = <span class="built_in">append</span>(opts, grpc.UnaryInterceptor(interceptor))</span><br><span class="line"></span><br><span class="line">	g := grpc.NewServer(opts...)</span><br><span class="line">	proto.RegisterGreeterServer(g, &amp;Server&#123;&#125;)</span><br><span class="line">	lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:50051&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;failed to listen:&quot;</span>+err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">	err = g.Serve(lis)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc:&quot;</span>+err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="grpc的状态码"><a href="#grpc的状态码" class="headerlink" title="grpc的状态码"></a><strong>grpc的状态码</strong></h3><p><a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/blob/master/doc/statuscodes.md">https://github.com/grpc/grpc/blob/master/doc/statuscodes.md</a></p>
<hr>
<h3 id="grpc中的错误处理"><a href="#grpc中的错误处理" class="headerlink" title="grpc中的错误处理"></a><strong>grpc中的错误处理</strong></h3><ol>
<li>服务端生成错误信息</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err :=  status.Errorf(codes.NotFound, <span class="string">&quot;记录未找到：%s&quot;</span>, request.Name)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>客户端获取错误中的状态信息</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">st, ok := status.FromError(err)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">    <span class="comment">// Error was not a status error</span></span><br><span class="line">&#125;</span><br><span class="line">st.Message()</span><br><span class="line">st.Code()</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="grpc中的超时机制"><a href="#grpc中的超时机制" class="headerlink" title="grpc中的超时机制"></a><strong>grpc中的超时机制</strong></h3><p>在客户端设置超时时间3s</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024231.png" alt="image-20250205233201931" style="zoom: 50%;" />

<p>服务端等待10s</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024232.png" alt="image-20250205233221474" style="zoom:50%;" />

<p>此时，客户端在发出请求3s后会直接返回错误</p>
<hr>
<h3 id="protoc生成的go的源码里面有什么？"><a href="#protoc生成的go的源码里面有什么？" class="headerlink" title="protoc生成的go的源码里面有什么？"></a><strong>protoc生成的go的源码里面有什么？</strong></h3><p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>proto 中的 message 会生成 go 文件中的 struct</p>
<p><img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024233.png" alt="image-20250205233739011"></p>
<p><img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024234.png" alt="image-20250205233817761"></p>
<p><strong>服务端：</strong></p>
<p>service 生成了 server 的接口</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024235.png" alt="image-20250205233644501" style="zoom:67%;" />

<p>生成了注册方法</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024236.png" alt="image-20250205233915970" style="zoom: 67%;" />

<p>服务端调用时，实现对应的业务逻辑（SayHello）然后直接将实现业务逻辑的结构体注册即可</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024237.png" alt="image-20250205235101434" style="zoom: 50%;" />

<p><strong>客户端：</strong></p>
<p>生成了client接口（与服务端参数不同）</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024238.png" alt="image-20250205234134892" style="zoom: 50%;" />

<p>通过new方法（类似于其它语言中的构造函数）生成接口，new返回的是greeterClient进行了一层包装将cc包装进来</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024239.png" alt="image-20250205234512046" style="zoom:67%;" />

<p>cc包装了调用的方法Invoke</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024241.png" alt="image-20250205234636412" style="zoom:67%;" />

<p>greeterClient通过cc.Invoke实现了SayHello方法的调用</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024242.png" alt="image-20250205234659177" style="zoom:67%;" />

<p>cc就是我们在客户端调用时生成的conn</p>
<img src="https://cdn.jsdelivr.net/gh/shnpd/blog-pic@main/csdn/20250303130024243.png" alt="image-20250205234906535" style="zoom:67%;" />
</div><div class="article-licensing box"><div class="licensing-title"><p>【Go】grpc+protobuf详解</p><p><a href="https://shnpd.github.io/2025/03/03/gonote/【Go】grpc+protobuf详解/">https://shnpd.github.io/2025/03/03/gonote/【Go】grpc+protobuf详解/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>ShiHaonan</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2025-03-03</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-03-19</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/go/">go</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/images/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/images/wxpay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2025/03/03/gonote/%E3%80%90Go%E3%80%91map%E7%9A%84%E5%A3%B0%E6%98%8E%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E9%97%AE%E9%A2%98/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">【Go】map的声明与初始化问题</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/03/03/gonote/%E3%80%90Go%E3%80%91make%E5%92%8Cnew%E7%9A%84%E5%8C%BA%E5%88%AB/"><span class="level-item">【Go】make和new的区别</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card" id="comments"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://shnpd.github.io/2025/03/03/gonote/%E3%80%90Go%E3%80%91grpc+protobuf%E8%AF%A6%E8%A7%A3/';
            this.page.identifier = '2025/03/03/gonote/【Go】grpc+protobuf详解/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'shns-blog' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Protobuf详解"><span class="level-left"><span class="level-item">1</span><span class="level-item">Protobuf详解</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#默认值"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">默认值</span></span></a></li><li><a class="level is-mobile" href="#option-go-package"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">option go_package</span></span></a></li><li><a class="level is-mobile" href="#编号问题"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">编号问题</span></span></a></li><li><a class="level is-mobile" href="#import其它的proto文件"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">import其它的proto文件</span></span></a></li><li><a class="level is-mobile" href="#嵌套的message对象"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">嵌套的message对象</span></span></a></li><li><a class="level is-mobile" href="#枚举类型"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">枚举类型</span></span></a></li><li><a class="level is-mobile" href="#map类型"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">map类型</span></span></a></li><li><a class="level is-mobile" href="#内置timestamp类型"><span class="level-left"><span class="level-item">1.8</span><span class="level-item">内置timestamp类型</span></span></a></li></ul></li><li><a class="level is-mobile" href="#grpc详解"><span class="level-left"><span class="level-item">2</span><span class="level-item">grpc详解</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#什么是rpc"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">什么是rpc</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#rpc开发的四大要素"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">rpc开发的四大要素</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#grpc"><span class="level-left"><span class="level-item">3</span><span class="level-item">grpc</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#grpc的四种数据流"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">grpc的四种数据流</span></span></a></li><li><a class="level is-mobile" href="#proto"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">proto</span></span></a></li><li><a class="level is-mobile" href="#服务端"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">服务端</span></span></a></li><li><a class="level is-mobile" href="#客户端"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">客户端</span></span></a></li><li><a class="level is-mobile" href="#grpc的metadata机制"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">grpc的metadata机制</span></span></a></li><li><a class="level is-mobile" href="#grpc拦截器"><span class="level-left"><span class="level-item">3.6</span><span class="level-item">grpc拦截器</span></span></a></li><li><a class="level is-mobile" href="#通过拦截器和metadata实现grpc的auth认证"><span class="level-left"><span class="level-item">3.7</span><span class="level-item">通过拦截器和metadata实现grpc的auth认证</span></span></a></li><li><a class="level is-mobile" href="#grpc的验证器"><span class="level-left"><span class="level-item">3.8</span><span class="level-item">grpc的验证器</span></span></a></li><li><a class="level is-mobile" href="#grpc的状态码"><span class="level-left"><span class="level-item">3.9</span><span class="level-item">grpc的状态码</span></span></a></li><li><a class="level is-mobile" href="#grpc中的错误处理"><span class="level-left"><span class="level-item">3.10</span><span class="level-item">grpc中的错误处理</span></span></a></li><li><a class="level is-mobile" href="#grpc中的超时机制"><span class="level-left"><span class="level-item">3.11</span><span class="level-item">grpc中的超时机制</span></span></a></li><li><a class="level is-mobile" href="#protoc生成的go的源码里面有什么？"><span class="level-left"><span class="level-item">3.12</span><span class="level-item">protoc生成的go的源码里面有什么？</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-04-21T12:20:00.000Z">2025-04-21</time></p><p class="title"><a href="/2025/04/21/gonote/%E3%80%90Go%E3%80%91%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">【Go】堆和栈变量</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-19T16:00:00.000Z">2025-03-20</time></p><p class="title"><a href="/2025/03/20/gonote/%E3%80%90Go%E3%80%91atomic%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/">【Go】atomic原子操作</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-14T16:00:00.000Z">2025-03-15</time></p><p class="title"><a href="/2025/03/15/interview/redis/%E3%80%90redis%E3%80%91%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">【redis】数据类型</a></p><p class="categories"><a href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/">知识点整理</a> / <a href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/redis/">redis</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-02T16:00:00.000Z">2025-03-03</time></p><p class="title"><a href="/2025/03/03/gonote/%E3%80%90Go%E3%80%91Channel/">【Go】Channel</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-03-02T16:00:00.000Z">2025-03-03</time></p><p class="title"><a href="/2025/03/03/gonote/%E3%80%90Go%E3%80%91CSP%E6%A8%A1%E5%9E%8B/">【Go】CSP模型</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Fabric/"><span class="level-start"><span class="level-item">Fabric</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/Golang/"><span class="level-start"><span class="level-item">Golang</span></span><span class="level-end"><span class="level-item tag">45</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Shell%E8%84%9A%E6%9C%AC/"><span class="level-start"><span class="level-item">Shell脚本</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/bytedance/"><span class="level-start"><span class="level-item">bytedance</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E4%BB%A5%E5%A4%AA%E5%9D%8A/"><span class="level-start"><span class="level-item">以太坊</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%88%B7%E9%A2%98%E9%9B%86/"><span class="level-start"><span class="level-item">刷题集</span></span><span class="level-end"><span class="level-item tag">27</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%89%8D%E7%AB%AF/"><span class="level-start"><span class="level-item">前端</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/"><span class="level-start"><span class="level-item">区块链</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AD%A6%E6%9C%AF/"><span class="level-start"><span class="level-item">学术</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/"><span class="level-start"><span class="level-item">密码学</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/"><span class="level-start"><span class="level-item">小程序</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"><span class="level-start"><span class="level-item">操作系统</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"><span class="level-start"><span class="level-item">数据结构</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"><span class="level-start"><span class="level-item">机器学习</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%9D%82%E9%A1%B9/"><span class="level-start"><span class="level-item">杂项</span></span><span class="level-end"><span class="level-item tag">31</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%AF%94%E7%89%B9%E5%B8%81/"><span class="level-start"><span class="level-item">比特币</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/"><span class="level-start"><span class="level-item">知识点整理</span></span><span class="level-end"><span class="level-item tag">19</span></span></a><ul><li><a class="level is-mobile" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/mysql/"><span class="level-start"><span class="level-item">mysql</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/redis/"><span class="level-start"><span class="level-item">redis</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"><span class="level-start"><span class="level-item">操作系统</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"><span class="level-start"><span class="level-item">计算机网络</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/%E7%AE%97%E6%B3%95/"><span class="level-start"><span class="level-item">算法</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/"><span class="level-start"><span class="level-item">网络安全</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"><span class="level-start"><span class="level-item">计算机网络</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">shn&#039;s blog</a><p class="is-size-7"><span>&copy; 2025 ShiHaonan</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">Welcome to shn's blog!</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>