---
title: 【Go】堆和栈变量
toc: true
date: 2025-03-03 00:00:00
tags: go
categories: 
	- Golang
---

点击阅读更多查看文章内容<!--more-->

在 Go 语言中，变量的分配位置（堆或栈）是由 **编译器** 根据变量的生命周期和使用方式自动决定的。以下是堆栈分配的基本规则和常见情况：

### 1. **栈分配的变量**

栈分配的变量通常具有 **确定且较短的生命周期**，例如局部变量。栈分配速度快，但空间有限。

#### 栈分配的典型情况：

- 局部变量：

  - 在函数内部声明的变量，且未逃逸到函数外部。

  - 示例：

    ```go
    func foo() {
        x := 10 // x 分配在栈上
        fmt.Println(x)
    }
    ```

- 函数参数：

  - 传递给函数的参数变量。

  - 示例：

    ```go
    func bar(y int) {
        fmt.Println(y) // y 分配在栈上
    }
    ```

- 临时变量：

  - 在表达式或语句中使用的临时变量。

  - 示例：

    ```go
    func baz() {
        a := 5
        b := 10
        c := a + b // c 分配在栈上
        fmt.Println(c)
    }
    ```

### 2. **堆分配的变量**

堆分配的变量通常具有 **不确定或较长的生命周期**，例如逃逸到函数外部的变量或动态分配的内存。堆分配速度较慢，但空间较大。

#### 堆分配的典型情况：

- 逃逸到函数外部的变量：

  - 如果变量的地址被返回或传递到函数外部，编译器会将其分配到堆上。

  - 示例：

    ```go
    func escape() *int {
        x := 10 // x 逃逸到堆上
        return &x
    }
    ```

- 动态分配的内存：

  - 使用 `new` 或 `make` 分配的内存通常分配到堆上。

  - 示例：

    ```go
    func dynamic() {
        s := make([]int, 10) // s 分配在堆上
        fmt.Println(s)
    }
    ```

- 大对象：

  - 较大的对象（如大数组或结构体）可能会分配到堆上，以避免栈溢出。

  - 示例：

    ```go
    func large() {
        var arr [100000]int // arr 可能分配到堆上
        fmt.Println(arr[0])
    }
    ```

- 闭包捕获的变量：

  - 被闭包捕获的变量会分配到堆上，因为闭包可能在函数返回后继续使用这些变量。

  - 示例：

    ```go
    func closure() func() int {
        x := 10 // x 逃逸到堆上
        return func() int {
            return x
        }
    }
    ```

### 3. **逃逸分析（Escape Analysis）**

Go 编译器通过 **逃逸分析** 决定变量是否分配到堆上。逃逸分析的目标是尽可能将变量分配到栈上，以提高性能。

#### 逃逸分析的规则：

- 变量是否逃逸：
  - 如果变量的地址被传递到函数外部，或者被闭包捕获，则逃逸到堆上。
- 变量的大小：
  - 较大的变量可能分配到堆上，以避免栈溢出。
- 变量的生命周期：
  - 生命周期较长的变量可能分配到堆上。

### 4. **堆栈分配的总结**

|   **特性**   |          **栈分配**          |              **堆分配**              |
| :----------: | :--------------------------: | :----------------------------------: |
| **生命周期** |          确定且较短          |             不确定或较长             |
| **分配速度** |              快              |                  慢                  |
| **空间限制** |             较小             |                 较大                 |
| **典型情况** | 局部变量、函数参数、临时变量 | 逃逸变量、动态内存、大对象、闭包变量 |